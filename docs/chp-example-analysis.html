<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>chp-example-analysis.knit</title>

<script src="site_libs/header-attrs-2.30/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/flatly.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>



<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; } /* Alert */
code span.an { color: #008000; } /* Annotation */
code span.at { } /* Attribute */
code span.bu { } /* BuiltIn */
code span.cf { color: #0000ff; } /* ControlFlow */
code span.ch { color: #008080; } /* Char */
code span.cn { } /* Constant */
code span.co { color: #008000; } /* Comment */
code span.cv { color: #008000; } /* CommentVar */
code span.do { color: #008000; } /* Documentation */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.im { } /* Import */
code span.in { color: #008000; } /* Information */
code span.kw { color: #0000ff; } /* Keyword */
code span.op { } /* Operator */
code span.ot { color: #ff4000; } /* Other */
code span.pp { color: #ff4000; } /* Preprocessor */
code span.sc { color: #008080; } /* SpecialChar */
code span.ss { color: #008080; } /* SpecialString */
code span.st { color: #008080; } /* String */
code span.va { } /* Variable */
code span.vs { color: #008080; } /* VerbatimString */
code span.wa { color: #008000; font-weight: bold; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">
/* for pandoc --citeproc since 2.11 */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html"></a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="computer-setup.html">Computer Setup</a>
</li>
<li>
  <a href="NEON-data-intro.html">NEON Data</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Chapters
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="00-module-contents.html">Chapter overview</a>
    </li>
    <li class="divider"></li>
    <li class="dropdown-header">Core lessons</li>
    <li>
      <a href="chp-computer-navigation.html">1. Computer navigation</a>
    </li>
    <li>
      <a href="chp-intro-to-R.html">2. Intro to R</a>
    </li>
    <li>
      <a href="chp-spreadsheets.html">3. Spreadsheets</a>
    </li>
    <li>
      <a href="chp-data-structures.html">4. Data structures</a>
    </li>
    <li>
      <a href="chp-functions.html">5. Functions</a>
    </li>
    <li>
      <a href="chp-ggplot2-part1.html">6. Intro to ggplot2</a>
    </li>
    <li>
      <a href="chp-tidyverse-basics.html">7. Tidy data</a>
    </li>
    <li>
      <a href="chp-program-flow.html">8. Program flow</a>
    </li>
    <li>
      <a href="chp-example-analysis.html">9. Example analysis</a>
    </li>
  </ul>
</li>
<li>
  <a href="download-student-RStudio-project.html">RStudio Workbook &amp; Exercises</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">




</div>


<div id="chapter-8.-controlling-program-flow"
class="section level1 tabset">
<h1 class="tabset">Chapter 8. Controlling program flow</h1>
<div id="overview" class="section level2">
<h2>Overview</h2>
<p><strong>THIS CHAPTER IS NOT READY FOR LEARNERS</strong></p>
<div id="what-we-will-learn" class="section level3">
<h3>What we will learn</h3>
<p>In this lesson we will practice skills from all core lessons to
conduct an analysis on NEON data. We will use a reproducible workflow
and save our analysis as an RStudio project.</p>
</div>
<div id="prerequisites" class="section level3">
<h3>Prerequisites</h3>
<p>Before beginning this lesson you should have completed all prior
lessons and any prerequisites therein.</p>
<p>Before you begin, set up an RStudio project for an organized and
reproducible analysis:</p>
<ol style="list-style-type: decimal">
<li>Open Rstudio and create a new project named NEON_project.</li>
<li>Inside the NEON_project folder, create a folder named
<code>code</code>. During this lesson you will create two new code
scripts inside this folder.</li>
<li>Inside the NEON_project folder, create a folder named
<code>data</code>. During this lesson you will create several derived
data sets for your analysis. These derived data tables will be saved in
this <code>data</code> folder.</li>
<li>Insider the derived data folder, create a folder named
<code>output</code>. The code from this lesson will generate figures
that will save into this folder.</li>
<li>Be sure to click <strong>Save</strong> often to save your work.</li>
</ol>
<p>The final output of this lesson is available in the chapter 8
exercises folder of the workbook.</p>
</div>
</div>
<div id="lesson" class="section level2">
<h2>Lesson</h2>
<p>In this lesson we will be working on an analysis of macroinvertebrate
diversity at three NEON aquatic sites: Caribou Creek, Alaska (CARI),
Martha Creek, Washington (MART), and Teakettle Creek, California (TECR).
You can see a map of these sites on the <a
href="https://www.neonscience.org/field-sites/explore-field-sites">NEON
website</a>. Our goal is to evaluate which site has the highest summer
macroinvertebrate diversity and determine whether macroinvertebrate
abundance is related to water temperature over the course of the
summer.</p>
<p>Before beginning an analysis, it can be extremely useful to map out
the steps ahead of time. This will make it easier to translate the
analysis to code.</p>
<p>Let’s list our goals for analyzing macroinvertebrate diversity and
what we need to do to accomplish each:</p>
<p><strong>Goal 1:</strong> Compare the total number of
macroinvertebrate taxa at found at each site.</p>
<ol style="list-style-type: decimal">
<li>Start with the macroinvertebrates data downloaded from NEON.</li>
<li>Extract two tables from this download:
<ul>
<li><code>inv_fieldData</code> contains data on when and where the
invertebrate samples were collected</li>
<li><code>inv_taxonomyProcessed</code> contains taxonomic information
about which taxa were collected in each sample</li>
</ul></li>
<li>Use the <code>inv_taxonomyProcessed</code> table to count the number
of unique taxa found at each site, combining across all of the samples
from each site (which were collected at different locations and on two
separate sampling dates).</li>
<li>Output a table comparing these values.</li>
</ol>
<p><em><strong>Goal 2: Macroinvertebrate abundance
vs. temperature</strong></em></p>
<p>We are also nearly done with the second goal as well. Let’s see how
far we can get using functions that we have already learned.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="do">### Goal 2: Plot macroinvertebrate abundance and temperature over time</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="do">## Start with macroinvertebrate data tables</span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="do">## inv_fieldData and inv_taxonomyProcessed (saved as inv_taxa)</span></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="do">## Use surface water temperature data from TSW_30min</span></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a> </span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a> <span class="co"># Extract surface water temperature measurements</span></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a> <span class="co"># averaged over 30 min periods</span></span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a> TSW_30min <span class="ot">&lt;-</span> watertemp_list<span class="sc">$</span>TSW_30min</span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a> <span class="co"># Filter the temperature data to good observations</span></span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a> TSW_30min_good <span class="ot">&lt;-</span> <span class="fu">filter</span>(TSW_30min, finalQF <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a><span class="do">## Use inverts_taxa to calculate the total abundance of</span></span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a><span class="do">## macroinvertebrates in each sample from each site </span></span>
<span id="cb1-16"><a href="#cb1-16" tabindex="-1"></a>inverts_bysample <span class="ot">&lt;-</span> inv_taxa <span class="sc">|&gt;</span></span>
<span id="cb1-17"><a href="#cb1-17" tabindex="-1"></a>    <span class="fu">group_by</span>(siteID, sampleID) <span class="sc">|&gt;</span></span>
<span id="cb1-18"><a href="#cb1-18" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">total =</span> <span class="fu">sum</span>(estimatedTotalCount))</span>
<span id="cb1-19"><a href="#cb1-19" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" tabindex="-1"></a><span class="do">## Join inverts_bysample with inv_fieldData to determine the </span></span>
<span id="cb1-21"><a href="#cb1-21" tabindex="-1"></a><span class="do">## dates which each sample was collected and the amount of area sampled.</span></span>
<span id="cb1-22"><a href="#cb1-22" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" tabindex="-1"></a> <span class="co"># Since we don&#39;t need all the columns, we can just select the columns</span></span>
<span id="cb1-24"><a href="#cb1-24" tabindex="-1"></a> <span class="co"># of interest before joining.</span></span>
<span id="cb1-25"><a href="#cb1-25" tabindex="-1"></a> field_cols <span class="ot">&lt;-</span> inv_fieldData <span class="sc">|&gt;</span> </span>
<span id="cb1-26"><a href="#cb1-26" tabindex="-1"></a>   <span class="fu">select</span>(sampleID, collectDate, benthicArea)</span>
<span id="cb1-27"><a href="#cb1-27" tabindex="-1"></a></span>
<span id="cb1-28"><a href="#cb1-28" tabindex="-1"></a> <span class="co"># Join the invertebrate abundance with field data columns</span></span>
<span id="cb1-29"><a href="#cb1-29" tabindex="-1"></a> <span class="co"># left_join keeps all rows in inverts_bysample</span></span>
<span id="cb1-30"><a href="#cb1-30" tabindex="-1"></a> inverts_bysample <span class="ot">&lt;-</span> <span class="fu">left_join</span>(inverts_bysample, field_cols, <span class="at">by =</span> <span class="st">&quot;sampleID&quot;</span>)</span>
<span id="cb1-31"><a href="#cb1-31" tabindex="-1"></a></span>
<span id="cb1-32"><a href="#cb1-32" tabindex="-1"></a></span>
<span id="cb1-33"><a href="#cb1-33" tabindex="-1"></a><span class="do">## Control for variability in abundance based on the amount </span></span>
<span id="cb1-34"><a href="#cb1-34" tabindex="-1"></a><span class="do">## of area sampled by calculating density = abundance / area`</span></span>
<span id="cb1-35"><a href="#cb1-35" tabindex="-1"></a></span>
<span id="cb1-36"><a href="#cb1-36" tabindex="-1"></a>  inverts_bysample <span class="ot">&lt;-</span> inverts_bysample <span class="sc">|&gt;</span></span>
<span id="cb1-37"><a href="#cb1-37" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">density_per_m2 =</span> total <span class="sc">/</span> benthicArea)</span>
<span id="cb1-38"><a href="#cb1-38" tabindex="-1"></a> </span>
<span id="cb1-39"><a href="#cb1-39" tabindex="-1"></a> </span>
<span id="cb1-40"><a href="#cb1-40" tabindex="-1"></a><span class="do">## Calculate average macroinvertebrate density across all samples </span></span>
<span id="cb1-41"><a href="#cb1-41" tabindex="-1"></a><span class="do">## collected on the same date at the same site. </span></span>
<span id="cb1-42"><a href="#cb1-42" tabindex="-1"></a>  </span>
<span id="cb1-43"><a href="#cb1-43" tabindex="-1"></a>  </span>
<span id="cb1-44"><a href="#cb1-44" tabindex="-1"></a>  <span class="co"># Make a column that extracts the date from collectDate</span></span>
<span id="cb1-45"><a href="#cb1-45" tabindex="-1"></a>  inverts_bysample <span class="ot">&lt;-</span> inverts_bysample <span class="sc">|&gt;</span></span>
<span id="cb1-46"><a href="#cb1-46" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">collect_day =</span> <span class="fu">date</span>(collectDate))</span>
<span id="cb1-47"><a href="#cb1-47" tabindex="-1"></a>  <span class="co"># Note: we could have combined this step with the last</span></span>
<span id="cb1-48"><a href="#cb1-48" tabindex="-1"></a>  <span class="co"># step and created  two columns with one `mutate()`.</span></span>
<span id="cb1-49"><a href="#cb1-49" tabindex="-1"></a>  </span>
<span id="cb1-50"><a href="#cb1-50" tabindex="-1"></a>  <span class="co"># Summarize the samples by date and site</span></span>
<span id="cb1-51"><a href="#cb1-51" tabindex="-1"></a>  <span class="co"># calculate average macroinvertebrate density</span></span>
<span id="cb1-52"><a href="#cb1-52" tabindex="-1"></a>  <span class="co"># calculate number of samples averaged </span></span>
<span id="cb1-53"><a href="#cb1-53" tabindex="-1"></a>  inverts_bysite <span class="ot">&lt;-</span> inverts_bysample <span class="sc">|&gt;</span></span>
<span id="cb1-54"><a href="#cb1-54" tabindex="-1"></a>    <span class="fu">group_by</span>(siteID, collect_day) <span class="sc">|&gt;</span></span>
<span id="cb1-55"><a href="#cb1-55" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">density_per_m2 =</span> <span class="fu">mean</span>(density_per_m2),</span>
<span id="cb1-56"><a href="#cb1-56" tabindex="-1"></a>              <span class="at">n_samples =</span> <span class="fu">n</span>()) </span>
<span id="cb1-57"><a href="#cb1-57" tabindex="-1"></a>    </span>
<span id="cb1-58"><a href="#cb1-58" tabindex="-1"></a>  </span>
<span id="cb1-59"><a href="#cb1-59" tabindex="-1"></a><span class="do">## Calculate average temperature across both sensors for </span></span>
<span id="cb1-60"><a href="#cb1-60" tabindex="-1"></a><span class="do">## each time point at each site and save this in a new table</span></span>
<span id="cb1-61"><a href="#cb1-61" tabindex="-1"></a>  </span>
<span id="cb1-62"><a href="#cb1-62" tabindex="-1"></a>  TSW_avg <span class="ot">&lt;-</span> TSW_30min_good <span class="sc">|&gt;</span></span>
<span id="cb1-63"><a href="#cb1-63" tabindex="-1"></a>    <span class="fu">group_by</span>(siteID, startDateTime) <span class="sc">|&gt;</span></span>
<span id="cb1-64"><a href="#cb1-64" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">temp_avg_C =</span> <span class="fu">mean</span>(surfWaterTempMean),</span>
<span id="cb1-65"><a href="#cb1-65" tabindex="-1"></a>              <span class="at">n_obs =</span> <span class="fu">n</span>()) <span class="co"># keep track of the number of measurements averaged</span></span>
<span id="cb1-66"><a href="#cb1-66" tabindex="-1"></a>  </span>
<span id="cb1-67"><a href="#cb1-67" tabindex="-1"></a>  </span>
<span id="cb1-68"><a href="#cb1-68" tabindex="-1"></a><span class="do">## Graph macroinvertebrate density and temperature over time </span></span>
<span id="cb1-69"><a href="#cb1-69" tabindex="-1"></a><span class="do">## for the four sites.</span></span>
<span id="cb1-70"><a href="#cb1-70" tabindex="-1"></a>  </span>
<span id="cb1-71"><a href="#cb1-71" tabindex="-1"></a>  <span class="co"># Temperature vs. time colored by site</span></span>
<span id="cb1-72"><a href="#cb1-72" tabindex="-1"></a>  TSW_avg <span class="sc">|&gt;</span> </span>
<span id="cb1-73"><a href="#cb1-73" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> startDateTime, <span class="at">y =</span> temp_avg_C, <span class="at">color =</span> siteID)) <span class="sc">+</span></span>
<span id="cb1-74"><a href="#cb1-74" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb1-75"><a href="#cb1-75" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;Date&quot;</span>,</span>
<span id="cb1-76"><a href="#cb1-76" tabindex="-1"></a>         <span class="at">y =</span> <span class="fu">expression</span>(<span class="st">&quot;Surface water temperature&quot;</span><span class="sc">~</span>(degree<span class="sc">*</span>C)),</span>
<span id="cb1-77"><a href="#cb1-77" tabindex="-1"></a>         <span class="at">color =</span> <span class="st">&quot;NEON Site&quot;</span>)</span></code></pre></div>
<p><img src="images/rmd-08-unnamed-chunk-2-1.png" width="50%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>  </span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>  <span class="co"># Macroinvertebrate density vs. time</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>  inverts_bysite <span class="sc">|&gt;</span> </span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> collect_day, <span class="at">y =</span> density_per_m2, <span class="at">color =</span> siteID)) <span class="sc">+</span></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;Date&quot;</span>,</span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a>         <span class="at">y =</span> <span class="fu">expression</span>(<span class="st">&quot;Macroinvertebrate density (num. per&quot;</span><span class="sc">~</span>m<span class="sc">^</span><span class="dv">2</span>),</span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a>         <span class="at">color =</span> <span class="st">&quot;NEON Site&quot;</span>)</span></code></pre></div>
<p><img src="images/rmd-08-unnamed-chunk-2-2.png" width="50%" style="display: block; margin: auto;" /></p>
<p>The graph in the last step gave us a warning that rows of data were
omitted due to missing values. That’s what we wanted to have happen, so
we don’t need to try to address this warning.</p>
<p>We are almost done with the analysis- the last two steps require that
we match up temperature measurements with the dates when
macroinvertebrates were sampled.</p>
<p>Let’s match macroinvertebrate samples in the
<code>inverts_bysite</code> table to an average of temperatures measured
for a three day period before each sample was collected.</p>
<p>First we need to calculate average temperatures over the three-day
periods of time before each <code>collect_day</code> in
<code>inverts_bysite</code>. To do this we will use functions from the
<code>lubridate</code> package to define a set of time intervals that
correspond to each of the collection dates.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="co"># Define 3 day time intervals before each collection date</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>inverts_bysite<span class="sc">$</span>temp_interval <span class="ot">&lt;-</span> <span class="fu">interval</span>(<span class="at">end =</span> inverts_bysite<span class="sc">$</span>collect_day,</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>                                         <span class="at">start =</span> inverts_bysite<span class="sc">$</span>collect_day <span class="sc">-</span> <span class="fu">ddays</span>(<span class="dv">3</span>))</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a><span class="co"># Examine inverts_bysite</span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a>inverts_bysite</span></code></pre></div>
<pre><code># A tibble: 6 × 5
# Groups:   siteID [3]
  siteID collect_day density_per_m2 n_samples temp_interval                 
  &lt;chr&gt;  &lt;date&gt;               &lt;dbl&gt;     &lt;int&gt; &lt;Interval&gt;                    
1 CARI   2021-07-01           2925.         8 2021-06-28 UTC--2021-07-01 UTC
2 CARI   2021-08-26            701.         8 2021-08-23 UTC--2021-08-26 UTC
3 MART   2021-07-28           8635.         8 2021-07-25 UTC--2021-07-28 UTC
4 MART   2021-09-27           4698.         8 2021-09-24 UTC--2021-09-27 UTC
5 TECR   2021-07-27          63478.         8 2021-07-24 UTC--2021-07-27 UTC
6 TECR   2021-09-15          19571.         8 2021-09-12 UTC--2021-09-15 UTC</code></pre>
<p>Next we need to calculate the average temperature at each site within
the three-day time intervals that we defined. This sounds like a good
use for a <code>for</code> loop! We learned about <code>for</code> loops
in <a href="chp-program-flow.html">Controlling program flow</a>.
Although there are vectorized ways to accomplish this (see the
<code>purrr</code> package), a <code>for</code> loop will work fine
here.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="do">## Join inverts_bysite with temperature data that corresponds to the</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="do">## date when samples were collected.</span></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a> <span class="co"># Define a vector to hold the average temperatures</span></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a> <span class="co"># There will be one for each row in inverts_bysite</span></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a> N <span class="ot">&lt;-</span> <span class="fu">nrow</span>(inverts_bysite)</span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a> avg_temp <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, N) </span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a> <span class="co"># Loop through each row in inverts_bysite</span></span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a> <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N){</span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a>  </span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a>   <span class="co"># Define the time interval and site for this row</span></span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a>   this_interval <span class="ot">&lt;-</span> inverts_bysite<span class="sc">$</span>temp_interval[i]</span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a>   this_site <span class="ot">&lt;-</span> inverts_bysite<span class="sc">$</span>siteID[i]</span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a>  </span>
<span id="cb5-16"><a href="#cb5-16" tabindex="-1"></a>   <span class="co"># Get all rows from TWS_avg within the time interval for this row</span></span>
<span id="cb5-17"><a href="#cb5-17" tabindex="-1"></a>   use_temps <span class="ot">&lt;-</span> <span class="fu">filter</span>(TSW_avg, </span>
<span id="cb5-18"><a href="#cb5-18" tabindex="-1"></a>                       startDateTime <span class="sc">%within%</span> this_interval,</span>
<span id="cb5-19"><a href="#cb5-19" tabindex="-1"></a>                       siteID <span class="sc">==</span> this_site)</span>
<span id="cb5-20"><a href="#cb5-20" tabindex="-1"></a>  </span>
<span id="cb5-21"><a href="#cb5-21" tabindex="-1"></a>   <span class="co"># Calculate the average temperature and save it in avg_temp</span></span>
<span id="cb5-22"><a href="#cb5-22" tabindex="-1"></a>   <span class="co"># remove any missing values</span></span>
<span id="cb5-23"><a href="#cb5-23" tabindex="-1"></a>   avg_temp[i] <span class="ot">&lt;-</span> <span class="fu">mean</span>(use_temps<span class="sc">$</span>temp_avg_C, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-24"><a href="#cb5-24" tabindex="-1"></a> }</span>
<span id="cb5-25"><a href="#cb5-25" tabindex="-1"></a></span>
<span id="cb5-26"><a href="#cb5-26" tabindex="-1"></a> <span class="co"># Add avg_temp as a new column in inverts_bysite</span></span>
<span id="cb5-27"><a href="#cb5-27" tabindex="-1"></a> inverts_bysite<span class="sc">$</span>temp_avg_3day <span class="ot">&lt;-</span> avg_temp</span>
<span id="cb5-28"><a href="#cb5-28" tabindex="-1"></a> </span>
<span id="cb5-29"><a href="#cb5-29" tabindex="-1"></a> <span class="co"># View the data</span></span>
<span id="cb5-30"><a href="#cb5-30" tabindex="-1"></a> inverts_bysite</span></code></pre></div>
<pre><code># A tibble: 6 × 6
# Groups:   siteID [3]
  siteID collect_day density_per_m2 n_samples temp_interval                  temp_avg_3day
  &lt;chr&gt;  &lt;date&gt;               &lt;dbl&gt;     &lt;int&gt; &lt;Interval&gt;                             &lt;dbl&gt;
1 CARI   2021-07-01           2925.         8 2021-06-28 UTC--2021-07-01 UTC          5.29
2 CARI   2021-08-26            701.         8 2021-08-23 UTC--2021-08-26 UTC          4.13
3 MART   2021-07-28           8635.         8 2021-07-25 UTC--2021-07-28 UTC         15.6 
4 MART   2021-09-27           4698.         8 2021-09-24 UTC--2021-09-27 UTC         12.0 
5 TECR   2021-07-27          63478.         8 2021-07-24 UTC--2021-07-27 UTC         14.6 
6 TECR   2021-09-15          19571.         8 2021-09-12 UTC--2021-09-15 UTC         12.6 </code></pre>
<p>Now that we have macroinvertebrate abundance and temperature in the
same data frame, we’re ready to move on to the last step.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="do">## Graph macroinvertebrate density versus water temperature as a scatterplot.</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="do">## Connect points from the same site with arrows pointing from the </span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a><span class="do">## first to the second sample.</span></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>inverts_bysite <span class="sc">|&gt;</span></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> temp_avg_3day, <span class="at">y =</span> density_per_m2)) <span class="sc">+</span> </span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> siteID)) <span class="sc">+</span> </span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="fu">expression</span>(<span class="st">&quot;Surface water temperature&quot;</span><span class="sc">~</span>(degree<span class="sc">*</span>C)),</span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a>         <span class="at">y =</span> <span class="fu">expression</span>(<span class="st">&quot;Macroinvertebrate density (num. per&quot;</span><span class="sc">~</span>m<span class="sc">^</span><span class="dv">2</span>),</span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a>         <span class="at">color =</span> <span class="st">&quot;NEON Site&quot;</span>)</span></code></pre></div>
<p><img src="images/rmd-08-unnamed-chunk-5-1.png" width="50%" style="display: block; margin: auto;" /></p>
<div id="refs" class="references csl-bib-body hanging-indent"
entry-spacing="0">
<div id="ref-NEON-surfwatertemp" class="csl-entry">
National Ecological Observatory Network (NEON). 2023. <span>“Temperature
(PRT) in Surface Water (DP1.20053.001).”</span> National Ecological
Observatory Network (NEON). <a
href="https://doi.org/10.48443/33ZJ-CQ24">https://doi.org/10.48443/33ZJ-CQ24</a>.
</div>
</div>
</div>
</div>

<hr>
<p>Introduction to Computing in R with NEON</p>



</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
